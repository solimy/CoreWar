<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>VM</title>
<script>
        var canvas;var ctx;

        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function display(vm) {
                var instructionPtrs = [];
                var keysIt = vm.processes.keys();
                for (processIt = keysIt.next(); processIt.value != undefined; processIt = keysIt.next()) {
                    instructionPtrs.push({i:vm.processes.get(processIt.value).instructionPtr, x:0, y:0, color:""});
                }
                var x = 0;
                var y = 0;
                for (i = 0, j = vm.memorySize; i < j; ++i) {
                        var color = (!vm.processes.has(vm.memory[i].owner) ? "rgba(255,255,255,1)" : vm.processes.get(vm.memory[i].owner).color);
                        for (instruction in instructionPtrs) {
                            if (instructionPtrs[instruction].i == i) {
                                instructionPtrs[instruction].x=x;
                                instructionPtrs[instruction].y=y;
                                instructionPtrs[instruction].color=color;
                            }
                        }
                        ctx.fillStyle=color;
                        ctx.fillRect(x, y, canvas.cellSize, canvas.cellSize);
                        if ((x+=canvas.cellSize) >= canvas.width) {
                            x = 0;
                            y+=canvas.cellSize;
                        }
                }
                ctx.fillStyle="rgba(200,200,200,1)";
                for (x = 0; x < canvas.width; x+=canvas.cellSize) {
                        ctx.fillRect(x, 0, 1, canvas.height);
                        ctx.fillRect(x+(canvas.cellSize-1), 0, 1, canvas.height);
                }
                for (y = 0; y < canvas.height; y+=canvas.cellSize) {
                        ctx.fillRect(0, y, canvas.width, 1);
                        ctx.fillRect(0, y+(canvas.cellSize-1), canvas.width, 1);
                }
                ctx.fillStyle="rgba(0,0,0,1)";
                ctx.strokeStyle="rgba(0,0,0,1)";
                for (i in instructionPtrs) {
                        ctx.fillRect(instructionPtrs[i].x+(canvas.cellSize/2.5), instructionPtrs[i].y+(canvas.cellSize/2.5), (canvas.cellSize/5), (canvas.cellSize/5));
                        ctx.strokeRect(instructionPtrs[i].x, instructionPtrs[i].y, canvas.cellSize, canvas.cellSize);
                }
        }

	function VM() {
                this.frequency = 1000/50;
                this.memorySize = 4*1024;
                this.memory = []; for (i = 0, j = this.memorySize; i < j; ++i) this.memory[i] = {value:0, owner:0};
                this.modIndex = this.memorySize;//512;
                this.cycleToDie = 1536;
                this.cycleDelta = 5;
                this.cycle = 0;
                this.nbrLive = 0;
                this.lastLivePid = 0;
		this.processes = new Map();
		this.lastPid = 0;
                this.instructions = [
                        {code:0x00, name:"exit", clock_cycles:1,
                                call: function(process) {
                                        vm.process_kill(process.pid, "exit");
                                        process.instructionPtr = vm.fold(process.instructionPtr+1);
                                }, vm:this},
                        {code:0x01, name:"live", clock_cycles:10,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var pid = vm.readMem(PC+1, 4);
                                        var p;
                                        if ((p=vm.processes.get(pid)) == undefined) vm.process_kill(process.pid, "illegal live("+pid+")");
                                        else p.lastLive = 0;
                                        console.log("process "+pid+" is alive");
                                        process.instructionPtr = vm.fold(PC+5);
                                        vm.nbrLive += 1;
                                }, vm:this},
                        {code:0x02, name:"ld", clock_cycles:5,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b10) {
                                                p1 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p1 == 0b11) {
                                                p1 = vm.readMem(PC+iSize, 2);
                                                p1 = vm.readMem(PC+(p1%vm.modIndex), 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal ld() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                process.registers[p2] = p1;
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal ld() p2");
                                        if (p3 != 0b00) vm.process_kill(process.pid, "illegal ld() p3");
                                        if (p4 != 0b00) vm.process_kill(process.pid, "illegal ld() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x03, name:"st", clock_cycles:5,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal st() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                process.registers[p2] = p1;
                                                iSize+=1;
                                        } else if (p2 == 0b11) {
                                                p2 = vm.readMem(PC+iSize, 2);
                                                vm.writeMem(PC+p2, p1, 4, process.pid);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal st() p2");
                                        if (p3 != 0b00) vm.process_kill(process.pid, "illegal st() p3");
                                        if (p4 != 0b00) vm.process_kill(process.pid, "illegal st() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x04, name:"add", clock_cycles:10,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal add() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                p2 = process.registers[p2];
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal add() p2");
                                        if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                                process.registers[p3] = p1 + p2;
                                                process.carry = (p1 + p2) ? (0) : (1);
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal add() p3");
                                        if (p4 != 0b00)  vm.process_kill(process.pid, "illegal add() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x05, name:"sub", clock_cycles:10,
                                call: function(process) {
                                var PC = process.instructionPtr;
                                var format = vm.readMem(PC+1, 1);
                                var iSize = 2;
                                var p4 = (format&0b11);
                                var p3 = ((format>>2)&0b11);
                                var p2 = ((format>>4)&0b11);
                                var p1 = ((format>>6)&0b11);
                                if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                        p1 = process.registers[p1];
                                        iSize+=1;
                                } else vm.process_kill(process.pid, "illegal sub() p1");
                                if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                        p2 = process.registers[p2];
                                        iSize+=1;
                                } else vm.process_kill(process.pid, "illegal sub() p2");
                                if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                        process.registers[p3] = p1 - p2;
                                        process.carry = (p1 - p2) ? (0) : (1);
                                        iSize+=1;
                                } else vm.process_kill(process.pid, "illegal sub() p3");
                                if (p4 != 0b00)  vm.process_kill(process.pid, "illegal sub() p4");
                                process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x06, name:"and", clock_cycles:6,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else if (p1 == 0b10) {
                                                p1 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p1 == 0b11) {
                                                p1 = vm.readMem(PC+iSize, 2);
                                                p1 = vm.readMem(PC+p1, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal and() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                p2 = process.registers[p2];
                                                iSize+=1;
                                        } else if (p2 == 0b10) {
                                                p2 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p2 == 0b11) {
                                                p2 = vm.readMem(PC+iSize, 2);
                                                p2 = vm.readMem(PC+p2, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal and() p2");
                                        if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                                process.registers[p3] = p1 & p2;
                                                process.carry = (p1 & p2) ? (0) : (1);
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal and() p3");
                                        if (p4 != 0b00)  vm.process_kill(process.pid, "illegal and() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x07, name:"or", clock_cycles:6,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else if (p1 == 0b10) {
                                                p1 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p1 == 0b11) {
                                                p1 = vm.readMem(PC+iSize, 2);
                                                p1 = vm.readMem(PC+p1, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal or() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                p2 = process.registers[p2];
                                                iSize+=1;
                                        } else if (p2 == 0b10) {
                                                p2 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p2 == 0b11) {
                                                p2 = vm.readMem(PC+iSize, 2);
                                                p2 = vm.readMem(PC+p2, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal or() p2");
                                        if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                                process.registers[p3] = p1 | p2;
                                                process.carry = (p1 | p2) ? (0) : (1);
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal or() p3");
                                        if (p4 != 0b00)  vm.process_kill(process.pid, "illegal or() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x08, name:"xor", clock_cycles:6,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else if (p1 == 0b10) {
                                                p1 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p1 == 0b11) {
                                                p1 = vm.readMem(PC+iSize, 2);
                                                p1 = vm.readMem(PC+p1, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal xor() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                p2 = process.registers[p2];
                                                iSize+=1;
                                        } else if (p2 == 0b10) {
                                                p2 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p2 == 0b11) {
                                                p2 = vm.readMem(PC+iSize, 2);
                                                p2 = vm.readMem(PC+p2, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal xor() p2");
                                        if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                                process.registers[p3] = p1 | p2;
                                                process.carry = (p1 | p2) ? (0) : (1);
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal xor() p3");
                                        if (p4 != 0b00)  vm.process_kill(process.pid, "illegal xor() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x09, name:"zjmp", clock_cycles:20,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var index = vm.readMem(PC+1, 2);
                                        if (process.carry == 1) process.instructionPtr += vm.fold(index);
                                        else process.instructionPtr = vm.fold(PC+3);
                                }, vm:this},
                        {code:0x0a, name:"ldi", clock_cycles:25,
                                call: function(process) {
                                        process.instructionPtr = (process.instructionPtr+1)%vm.memorySize;
                                }, vm:this},
                        {code:0x0b, name:"sti", clock_cycles:25,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal sti() p1");
                                        if (p2 == 0b10) {
                                                p2 = vm.readMem(PC+iSize, 2);
                                                iSize+=2;
                                        } else if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                p2 = process.registers[p2];
                                                iSize+=1;
                                        } else  vm.process_kill(process.pid, "illegal sti() p2");
                                        if (p3 == 0b10) {
                                                p3 = vm.readMem(PC+iSize, 2);
                                                iSize+=2;
                                        } else if (p3 == 0b01 && (p3=vm.readMem(PC+iSize, 1)-1) >= 0 && p3 < process.registers.length) {
                                                p3 = process.registers[p3];
                                                iSize+=1;
                                        } else  vm.process_kill(process.pid, "illegal sti() p3");
                                        if (p4 != 0b00)  vm.process_kill(process.pid, "illegal sti() p4");
                                        var target = PC + ((p2+p3)%vm.modIndex);
                                        vm.writeMem(target, p1, 4, process.pid);
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x0c, name:"fork", clock_cycles:800,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var index = vm.readMem(PC+1, 2);
                                        vm.process_fork(process, vm.fold(PC+(index%vm.modIndex)));
                                        process.instructionPtr = vm.fold(PC+3);
                                }, vm:this},
                        {code:0x0d, name:"lld", clock_cycles:10,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b10) {
                                                p1 = vm.readMem(PC+iSize, 4);
                                                iSize+=4;
                                        } else if (p1 == 0b11) {
                                                p1 = vm.readMem(PC+iSize, 2);
                                                p1 = vm.readMem(PC+p1, 4);
                                                iSize+=2;
                                        } else vm.process_kill(process.pid, "illegal lld() p1");
                                        if (p2 == 0b01 && (p2=vm.readMem(PC+iSize, 1)-1) >= 0 && p2 < process.registers.length) {
                                                process.registers[p2] = p1;
                                                iSize+=1;
                                        } else vm.process_kill(process.pid, "illegal lld() p2");
                                        if (p3 != 0b00) vm.process_kill(process.pid, "illegal lld() p3");
                                        if (p4 != 0b00) vm.process_kill(process.pid, "illegal lld() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                        {code:0x0e, name:"lldi", clock_cycles:50,
                                call: function(process) {
                                        process.instructionPtr = (process.instructionPtr+1)%vm.memorySize;
                                }, vm:this},
                        {code:0x0f, name:"lfork", clock_cycles:1000,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var index = vm.readMem(PC+1, 2);
                                        vm.process_fork(process, vm.fold(PC+index));
                                        process.instructionPtr = vm.fold(PC+3);
                                }, vm:this},
                        {code:0x10, name:"aff", clock_cycles:2,
                                call: function(process) {
                                        var PC = process.instructionPtr;
                                        var format = vm.readMem(PC+1, 1);
                                        var iSize = 2;
                                        var p4 = (format&0b11);
                                        var p3 = ((format>>2)&0b11);
                                        var p2 = ((format>>4)&0b11);
                                        var p1 = ((format>>6)&0b11);
                                        if (p1 == 0b01 && (p1=vm.readMem(PC+iSize, 1)-1) >= 0 && p1 < process.registers.length) {
                                                p1 = process.registers[p1];
                                                iSize+=1;
                                                console.log(String.fromCharCode(p1));
                                        } else vm.process_kill(process.pid, "illegal aff() p1");
                                        if (p2 != 0b00) vm.process_kill(process.pid, "illegal aff() p2");
                                        if (p3 != 0b00) vm.process_kill(process.pid, "illegal aff() p3");
                                        if (p4 != 0b00) vm.process_kill(process.pid, "illegal aff() p4");
                                        process.instructionPtr = vm.fold(PC+iSize);
                                }, vm:this},
                ];
	}

	VM.prototype = {
                fold: function(index) {
                        return (index%this.memorySize);
                },
                readMem: function(index, size) {
                        var value = 0;
                        var mask1 = 0x80;
                        var mask2 = 0x100;
                        value = this.memory[index%this.memorySize].value;
                        while (--size > 0) {
                            ++index;
                            value = value << 8;
                            value = value + this.memory[index%this.memorySize].value;
                            mask1 = mask1 << 8;
                            mask2 = mask2 << 8;
                        }
                        return ((value & mask1) > 0 ? (value - mask2) : (value));
                },
                writeMem: function(index, value, size, owner) {
                        if (value < 0) value = value + (0x1 << (8*size))
                        do {
                                vm.memory[(index+(--size))%this.memorySize].value = (value&0xff);
                                vm.memory[(index+(size))%this.memorySize].owner = owner;
                                value >>= 8;
                        } while (size > 0);
                },
		alloc: function(size) {
                        return 0;
                },
		alloc_rand: function(size) {
			var ok = false;
			var index;
			var security = 0;

			if (size > this.memorySize) {
				return -1;
			} else if (this.processes.size == 0) {
                                index = Math.floor(Math.random()*this.memorySize);
                        } else while (!ok) {
				index = Math.floor(Math.random()*this.memorySize);			
				var keysIt = this.processes.keys();
				for (processIt = keysIt.next(); processIt.value != undefined; processIt = keysIt.next()) {
					var process = this.processes.get(processIt.value);
                                        if (!(process.instructionPtr + process.size - index >= 0 && index+size - process.instructionPtr >= 0)) ok = true;
				}
				if (++security >= 10) return -1;
			}
                        console.log("allocated "+size+" bytes at address "+index);
			return index;
		},
                process_create: function(executable) {
                        var index = this.alloc_rand(executable.bin.length);
                        if (index < 0) return;
                        var process = {
                                pid: ++this.lastPid,
                                name: executable.name,
                                color: "rgba("+randInt(0,255)+","+randInt(0,255)+","+randInt(0,255)+",1)",
                                parent:0,
                                child:[],
                                alive:true,
                                size:executable.bin.length,
                                start:index,
                                instructionPtr:index,
                                registers:[this.lastPid, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                carry: 0,
                                wait: {done:true, cycles:0},
                                lastLive: 0
                        };
                        this.processes.set(this.lastPid, process);
                        for (i = 0, j = executable.bin.length; i < j; ++i) {
                                this.memory[index].value = executable.bin[i];
                                this.memory[index].owner = this.lastPid;
                                index = (index+1)%this.memorySize;
                        }
                        return process;
                },
                process_fork: function(father, index) {
                        var tmp = father.instructionPtr - father.start;
                        if (tmp < 0) tmp += this.memorySize;
                        tmp = (tmp+index+3)%this.memorySize;
                        var child = {
                                pid: ++this.lastPid,
                                name: father.name,
                                color: father.color,
                                parent: father.pid,
                                child:[],
                                alive:true,
                                size: father.size,
                                start: index,
                                instructionPtr: tmp,
                                registers: [this.lastPid, father.registers[1], father.registers[2], father.registers[3], father.registers[4], father.registers[5], father.registers[6], father.registers[7], father.registers[8], father.registers[9], father.registers[10], father.registers[11], father.registers[12], father.registers[13], father.registers[14], father.registers[15]],
                                carry: father.carry,
                                wait: {done:father.wait.done, cycles:father.wait.cycles},
                                lastLive: father.lastLive
                        };
                        father.child.push(child.pid);
                        this.processes.set(child.pid, child);
                        for (i = father.start, j = i+father.size; i < j; ++i) {
                                this.memory[index].value = this.memory[i%this.memorySize].value;
                                this.memory[index].owner = child.pid;
                                index = (index+1)%this.memorySize;
                        }
                        return child;
                },
                process_kill: function(pid, why) {
                        process = this.processes.get(pid);
                        process.alive = false;
                        console.log("killed process \""+process.name+"\" with pid: "+pid+" reason: "+why);
                        for (child in process.child) {
                                this.process_kill(process.child[child], "parent killed");
                        }
                        return 0;
                },
                processes_cleanUp: function() {
                        var keysIt = this.processes.keys();

                        for (processIt = keysIt.next(); processIt.value != undefined; processIt = keysIt.next()) {
                                var process = this.processes.get(processIt.value);
                                if (!process.alive) this.processes.delete(process.pid);
                        }
                        return 0;
                },
                step: function() {
                        if (++this.cycle >= this.cycleToDie) {
                                var keysIt = this.processes.keys();
                                for (processIt = keysIt.next(); processIt.value != undefined; processIt = keysIt.next()) {
                                        var process = this.processes.get(processIt.value);
                                        if (process.lastLive >= this.cycleToDie) this.process_kill(process.pid, "timeout");
                                }
                                this.cycle = -1;
                        }
                        if (this.nbrLive >= 40) {
                                this.cycleToDie -= this.cycleDelta;
                                this.nbrLive = 0;
                        }
                        this.processes_cleanUp();
                        var keysIt = this.processes.keys();
                        for (processIt = keysIt.next(); processIt.value != undefined; processIt = keysIt.next()) {
				var process = this.processes.get(processIt.value);
                                ++process.lastLive;
                                if (process.wait.done) {
                                        var instruction = this.memory[process.instructionPtr].value;
                                        if (instruction < 0 || instruction >= this.instructions.length) {
                                                this.process_kill(process.pid, "illegal instruction");
                                                continue;
                                        }
                                        process.wait.done = false;
                                        process.wait.cycles = this.instructions[instruction].clock_cycles;
                                } else if (--(process.wait.cycles) <= 0) {
                                        var instruction = this.memory[process.instructionPtr].value;
                                        if (instruction < 0 || instruction >= this.instructions.length) {
                                                this.process_kill(process.pid, "illegal instruction");
                                                continue;
                                        }
                                        this.instructions[instruction].call(process);
                                        process.wait.done = true;
                                }
                        }
                        display(this);
                        return 0;
                },
		run: function() {
                        var that = this;
                        this.cycle = -1;
                        var loop = setInterval(function() {
                                                    if (that.processes.size > 0)
                                                            that.step();
                                                    else {
                                                            that.lastPid = 0;
                                                            console.log("all processes are dead");
                                                            clearInterval(loop);
                                                    }
                                               }, vm.frequency);
                        return 0;
		}
	}

	function main() {
		vm = new VM();
                vm.process_create({
                        name:"zork",
                        bin:[
                          /*00*/0x0b,0x68,0x01,0x00,0x28,0x00,0x01,             //          sti   r1,%:live,%1
                          /*07*/0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,        //          and   r1,%0,r1
                          /*15*/0x02,0x90,0x00,0x00,0x00,0x1c,0x06,             //          ld    %28,r6
                          /*22*/0x02,0x90,0x00,0x00,0x00,0x08,0x07,             //loop:     ld    %8,r7
                          /*29*/0x0b,0x58,0x06,0x06,0x00,0x00,                  //          sti   r6,r6,%0
                          /*35*/0x04,0x54,0x06,0x07,0x06,                       //          add   r6,r7,r6
                          /*40*/0x01,0x00,0x00,0x00,0x00,                       //live:     live  %0
                          /*45*/0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,        //          and   %0,%0,r1
                          /*52*/0x09,0,-31,                                     //          zjmp  %:loop
                          /*55*/0x00                                            //end:      exit
                        ]});

                vm.process_create({
                        name:"zork",
                        bin:[
                          /*00*/0x0b,0x68,0x01,0x00,0x28,0x00,0x01,             //          sti   r1,%:live,%1
                          /*07*/0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,        //          and   r1,%0,r1
                          /*15*/0x02,0x90,0x00,0x00,0x00,0x42,0x06,             //          ld    %50,r6
                          /*22*/0x02,0x90,0x00,0x00,0x00,0x04,0x07,             //loop:     ld    %4,r7
                          /*29*/0x0b,0x58,0x06,0x06,0x00,0x00,                  //          sti   r6,r6,%0
                          /*35*/0x04,0x54,0x06,0x07,0x06,                       //          add   r6,r7,r6
                          /*40*/0x01,0x00,0x00,0x00,0x00,                       //live:     live  %0
                          /*45*/0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,        //          and   %0,%0,r1
                          /*52*/0x09,0,-31,                                     //          zjmp  %:loop
                          /*55*/0x00                                            //          exit
                        ]});

                vm.process_create({
                        name:"zork",
                        bin:[
                                0x0c,0x00,0x32,
                                0x0b,0x68,0x01,0x00,0x0F,0x00,0x01,
                                0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,
                                0x01,0x00,0x00,0x00,0x00,
                                0x09,0xFF,0xFB,
                                0x00
                        ]});

                vm.process_create({
                        name:"zork",
                        bin:[
                                0x0b,0x68,0x01,0x00,0x0F,0x00,0x01,
                                0x06,0x64,0x01,0x00,0x00,0x00,0x00,0x01,
                                0x01,0x00,0x00,0x00,0x00,
                                0x09,0,-5,
                                0x00
                        ]});

                vm.process_create({
                        name:"print_pid",
                        bin:[
                                0x10,0x40,0x01,
                                0x00
                        ]});
                canvas = document.createElement('canvas');

                canvas.id = "disp";
                canvas.cellSize = 10;
                canvas.width = (Math.sqrt(vm.memorySize)+1)*canvas.cellSize;
                canvas.height = (Math.sqrt(vm.memorySize)+1)*canvas.cellSize;
                canvas.style="border:1px solid #000000;"
                ctx=canvas.getContext("2d");
                ctx.lineWidth=canvas.cellSize/5;
                var body = document.getElementsByTagName("body")[0];
                body.appendChild(canvas);
                display(vm);
        }
</script>
</head>
<body onload="main()">
</body>
</html>
